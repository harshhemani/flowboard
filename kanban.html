<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowBoard</title>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-sidebar: #13203a;
            --bg-sidebar-hover: #1e3055;
            --bg-sidebar-active: #0a1628;
            --text-sidebar: #7b8fa8;
            --text-sidebar-active: #ffffff;
            --bg-col: #e8eaed;
            --bg-card: #ffffff;
            --bg-card-hover: #fdfdfe;
            --text-main: #111827;
            --text-muted: #6b7280;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --danger: #dc2626;
            --danger-hover: #b91c1c;
            --border: #e5e7eb;
            --border-focus: #2563eb;
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.07);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-focus: 0 0 0 3px rgba(37,99,235,0.15);
            --priority-low: #065f46;
            --priority-low-bg: #d1fae5;
            --priority-med: #92400e;
            --priority-med-bg: #fef3c7;
            --priority-high: #991b1b;
            --priority-high-bg: #fee2e2;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        :focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
        svg { width: 16px; height: 16px; fill: currentColor; flex-shrink: 0; pointer-events: none; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; font-size: 14px; transition: all 0.15s ease; }

        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s ease; white-space: nowrap; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 1px 2px rgba(37,99,235,0.3); }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 2px 8px rgba(37,99,235,0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-outline { border: 1px solid var(--border); background: white; color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-body); border-color: #d1d5db; }
        .btn-ghost { color: var(--text-muted); padding: 6px 8px; border-radius: 6px; }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .icon-btn { color: var(--text-muted); padding: 6px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: rgba(0,0,0,0.06); color: var(--text-main); }

        .app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; }

        .sidebar { width: 240px; background-color: var(--bg-sidebar); display: flex; flex-direction: column; transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; z-index: 10; flex-shrink: 0; }
        .sidebar.collapsed { width: 60px; }
        .sidebar.collapsed .hide-on-collapse { width: 0; overflow: hidden; opacity: 0; display: none; }

        .sidebar-header { height: 56px; padding: 0 16px; display: flex; align-items: center; gap: 10px; color: white; font-weight: 600; font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.07); white-space: nowrap; flex-shrink: 0; }
        .sidebar-logo { width: 28px; height: 28px; border-radius: 7px; background: linear-gradient(135deg, #3b82f6, #2563eb); display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(37,99,235,0.4); }
        .sidebar-logo svg { width: 14px; height: 14px; color: white; }
        .sidebar.collapsed .sidebar-header { padding: 0 16px; justify-content: center; }

        .projects-section { padding: 16px 10px; flex: 1; overflow-y: auto; overflow-x: hidden; }
        .projects-title { padding: 0 8px 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-sidebar); display: flex; justify-content: space-between; align-items: center; white-space: nowrap; }
        .sidebar.collapsed .projects-title { justify-content: center; }

        .project-item { padding: 9px 10px; margin-bottom: 2px; border-radius: 6px; cursor: pointer; color: var(--text-sidebar); display: flex; align-items: center; gap: 10px; transition: all 0.15s ease; white-space: nowrap; font-weight: 400; font-size: 13.5px; position: relative; }
        .project-item:hover { background-color: var(--bg-sidebar-hover); color: rgba(255,255,255,0.85); }
        .project-item.active { background-color: rgba(37,99,235,0.2); color: var(--text-sidebar-active); font-weight: 500; }
        .project-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 16px; background: #3b82f6; border-radius: 0 2px 2px 0; }
        .sidebar.collapsed .project-item { padding: 9px; justify-content: center; }
        .project-icon-wrap { width: 24px; height: 24px; border-radius: 5px; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.15s; }
        .project-item:hover .project-icon-wrap, .project-item.active .project-icon-wrap { background: rgba(255,255,255,0.12); }
        .project-icon-wrap svg { width: 12px; height: 12px; color: rgba(255,255,255,0.7); }

        /* Project item edit button */
        .project-edit-btn { opacity: 0; color: rgba(255,255,255,0.5); padding: 2px 4px; border-radius: 3px; margin-left: auto; flex-shrink: 0; }
        .project-edit-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .project-item:hover .project-edit-btn { opacity: 1; }

        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .top-bar { height: 56px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 14px; flex-shrink: 0; }
        .top-bar h1 { font-size: 17px; font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-actions { display: flex; gap: 10px; align-items: center; }

        /* Inline title editing */
        #projectTitleWrap { flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0; }
        #currentProjectTitle { font-size: 17px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #projectTitleInput { display: none; font-size: 17px; font-weight: 600; border: 1.5px solid var(--border-focus); border-radius: 6px; padding: 4px 10px; font-family: inherit; color: var(--text-main); background: white; box-shadow: var(--shadow-focus); min-width: 180px; max-width: 300px; }
        #editProjectNameBtn { color: var(--text-muted); opacity: 0; transition: opacity 0.15s; }
        #projectTitleWrap:hover #editProjectNameBtn { opacity: 1; }

        kbd { display: inline-flex; align-items: center; justify-content: center; background: #f3f4f6; border: 1px solid #d1d5db; border-bottom-width: 2px; border-radius: 4px; padding: 1px 5px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 10px; color: #374151; min-width: 20px; }

        .board-container { flex: 1; padding: 20px; overflow-x: auto; overflow-y: hidden; display: flex; gap: 16px; align-items: flex-start; min-width: 0; }

        .column { background-color: var(--bg-col); border-radius: 10px; flex: 1; min-width: 240px; max-height: 100%; display: flex; flex-direction: column; transition: background 0.2s ease, box-shadow 0.2s ease; }
        .column.drag-target { background-color: #d8ddf0; box-shadow: inset 0 0 0 2px rgba(37,99,235,0.25); }

        .column-header { padding: 14px 14px 10px; font-weight: 600; font-size: 11px; letter-spacing: 0.06em; color: var(--text-muted); text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .column-header .count { background: white; color: var(--text-muted); padding: 1px 7px; border-radius: 20px; font-size: 11px; font-weight: 600; box-shadow: var(--shadow-xs); }

        .column-body { padding: 4px 10px 10px 10px; flex: 1; overflow-y: auto; min-height: 120px; }
        .column-body.drag-over { background-color: rgba(37,99,235,0.04); border-radius: 6px; }

        .task-card { background: var(--bg-card); padding: 13px; border-radius: 8px; box-shadow: var(--shadow-xs); margin-bottom: 8px; cursor: grab; border: 1px solid rgba(0,0,0,0.05); transition: box-shadow 0.15s ease, transform 0.1s ease, border-color 0.15s, opacity 0.15s; position: relative; animation: cardIn 0.2s ease both; user-select: none; }
        body.is-dragging { cursor: grabbing !important; }
        body.is-dragging * { cursor: grabbing !important; }

        @keyframes cardIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        .task-card:hover { box-shadow: var(--shadow-md); border-color: rgba(0,0,0,0.1); transform: translateY(-1px); }
        .task-card:active { cursor: grabbing; transform: translateY(0); }
        .task-card.drag-source { opacity: 0 !important; pointer-events: none; }

        .drop-placeholder { border: 2px dashed rgba(37,99,235,0.35); border-radius: 8px; background: rgba(37,99,235,0.05); margin-bottom: 8px; overflow: hidden; animation: placeholderExpand 0.18s cubic-bezier(0.4,0,0.2,1) both; }
        @keyframes placeholderExpand { from { opacity: 0; transform: scaleY(0.5); } to { opacity: 1; transform: scaleY(1); } }

        #dragGhost { position: fixed; pointer-events: none; z-index: 9999; width: 270px; background: white; border-radius: 10px; padding: 13px; box-shadow: 0 24px 48px rgba(0,0,0,0.2), 0 6px 16px rgba(37,99,235,0.18); border: 1.5px solid rgba(37,99,235,0.3); will-change: transform; }

        .task-card.keyboard-selected { border-color: var(--primary); box-shadow: var(--shadow-focus), var(--shadow-sm); outline: none; }
        .task-card.moving { animation: moveFlash 0.25s ease; }
        @keyframes moveFlash { 0% { transform: scale(1); } 50% { transform: scale(1.02); background: var(--primary-light); } 100% { transform: scale(1); } }

        .task-badges { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 2px 7px; border-radius: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
        .badge-low { background: var(--priority-low-bg); color: var(--priority-low); }
        .badge-med { background: var(--priority-med-bg); color: var(--priority-med); }
        .badge-high { background: var(--priority-high-bg); color: var(--priority-high); }

        .task-title { font-weight: 500; font-size: 14px; margin-bottom: 5px; line-height: 1.4; color: var(--text-main); }
        .task-desc { font-size: 12.5px; color: var(--text-muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .task-footer { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .task-actions { opacity: 0; transition: opacity 0.15s; display: flex; gap: 2px; }
        .task-card:hover .task-actions, .task-card.keyboard-selected .task-actions { opacity: 1; }
        .task-actions button { padding: 4px 5px; }

        .add-task-inline { width: 100%; padding: 8px; border-radius: 6px; color: var(--text-muted); font-size: 13px; font-weight: 400; display: flex; align-items: center; gap: 6px; transition: all 0.15s; margin-top: 2px; border: 1px dashed transparent; }
        .add-task-inline:hover { background: rgba(37,99,235,0.06); color: var(--primary); border-color: rgba(37,99,235,0.2); }

        #toastContainer { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 9999; pointer-events: none; }
        .toast { background: #111827; color: white; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 8px; animation: toastIn 0.2s ease; pointer-events: auto; max-width: 300px; }
        @keyframes toastIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast.fade-out { animation: toastOut 0.2s ease forwards; }
        @keyframes toastOut { to { transform: translateY(4px); opacity: 0; } }
        .toast-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .toast-dot.success { background: #34d399; }
        .toast-dot.info { background: #60a5fa; }
        .toast-dot.warn { background: #f59e0b; }

        #shortcutsOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 2000; backdrop-filter: blur(4px); }
        #shortcutsOverlay.active { opacity: 1; pointer-events: auto; }
        .shortcuts-panel { background: white; border-radius: 12px; padding: 28px; width: 480px; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg); transform: translateY(10px); transition: transform 0.2s; }
        #shortcutsOverlay.active .shortcuts-panel { transform: translateY(0); }
        .shortcut-group { margin-bottom: 20px; }
        .shortcut-group-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); font-weight: 600; margin-bottom: 10px; }
        .shortcut-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f3f4f6; }
        .shortcut-keys { display: flex; gap: 4px; align-items: center; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.4); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.15s ease; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: white; padding: 28px; border-radius: 12px; width: 440px; box-shadow: var(--shadow-lg); transform: translateY(12px) scale(0.99); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.active .modal { transform: translateY(0) scale(1); }
        .modal-wide { width: 560px; }

        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 9px 12px; border: 1.5px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; transition: all 0.15s; background: white; color: var(--text-main); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--border-focus); box-shadow: var(--shadow-focus); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }

        /* Import/Export modal */
        .import-export-tabs { display: flex; gap: 0; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .import-export-tab { flex: 1; padding: 9px; text-align: center; font-size: 13px; font-weight: 500; color: var(--text-muted); background: white; border: none; cursor: pointer; transition: all 0.15s; }
        .import-export-tab:not(:last-child) { border-right: 1px solid var(--border); }
        .import-export-tab.active { background: var(--primary); color: white; }
        .import-export-tab:hover:not(.active) { background: var(--bg-body); }

        .export-scope { display: flex; flex-direction: column; gap: 8px; }
        .export-scope label { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1.5px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.15s; font-size: 13.5px; font-weight: 400; text-transform: none; color: var(--text-main); }
        .export-scope label:hover { border-color: var(--primary); background: var(--primary-light); }
        .export-scope input[type=radio] { accent-color: var(--primary); width: 15px; height: 15px; }

        .import-drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 32px; text-align: center; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
        .import-drop-zone:hover, .import-drop-zone.drag-active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
        .import-drop-zone svg { width: 32px; height: 32px; margin: 0 auto 10px; display: block; }
        .import-preview { background: #f8fafc; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 12px; font-family: ui-monospace, monospace; max-height: 150px; overflow-y: auto; color: var(--text-main); white-space: pre-wrap; word-break: break-all; }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); width: 100%; }
        .empty-state-icon { width: 56px; height: 56px; margin: 0 auto 16px; background: #f3f4f6; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .empty-state-icon svg { width: 26px; height: 26px; color: #9ca3af; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        .column[data-status="todo"] .column-status-bar { background: #6b7280; }
        .column[data-status="inprogress"] .column-status-bar { background: #f59e0b; }
        .column[data-status="done"] .column-status-bar { background: #10b981; }
        .column-status-bar { width: 32px; height: 3px; border-radius: 2px; }

        /* hidden file input */
        #importFileInput { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg viewBox="0 0 24 24"><path d="M3 3h7v7H3V3zm0 11h7v7H3v-7zm11-11h7v7h-7V3zm0 11h7v7h-7v-7z"/></svg>
                </div>
                <span class="hide-on-collapse" style="font-size:15px;letter-spacing:-0.02em;">FlowBoard</span>
            </div>
            <div class="projects-section">
                <div class="projects-title">
                    <span class="hide-on-collapse">Projects</span>
                    <button class="icon-btn" onclick="openProjectModal()" title="Create Project (N P)" style="color:var(--text-sidebar)">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                </div>
                <div id="projectList"></div>
            </div>
            <div style="padding: 12px 10px; border-top: 1px solid rgba(255,255,255,0.07); display:flex; flex-direction:column; gap:2px;">
                <button class="project-item hide-on-collapse" style="width:100%;margin:0;" onclick="openImportExportModal()">
                    <div class="project-icon-wrap">
                        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </div>
                    <span style="font-size:12.5px;">Import / Export</span>
                </button>
                <button class="project-item hide-on-collapse" style="width:100%;margin:0;" onclick="openShortcutsOverlay()">
                    <div class="project-icon-wrap">
                        <svg viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 4h2v2h-2v-2zM8 8h2v2H8V8zm0 4h2v2H8v-2zm-1 2H5v-2h2v2zm0-4H5V8h2v2zm9 4h-2v-2h2v2zm0-4h-2V8h2v2zm2 4h-2v-2h2v2zm0-4h-2V8h2v2z"/></svg>
                    </div>
                    <span style="font-size:12.5px;">Keyboard shortcuts</span>
                    <kbd style="margin-left:auto;font-size:9px;">?</kbd>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <button class="icon-btn" onclick="toggleSidebar()" title="Toggle Sidebar (‚åòB / Ctrl+B)">
                    <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>

                <div id="projectTitleWrap">
                    <h1 id="currentProjectTitle">Welcome to FlowBoard</h1>
                    <input type="text" id="projectTitleInput" placeholder="Project name" />
                    <button class="icon-btn" id="editProjectNameBtn" onclick="startEditingProjectName()" title="Rename project (F2)">
                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    </button>
                </div>

                <div class="header-actions" id="headerActions" style="display:none;">
                    <button class="btn btn-ghost" onclick="deleteCurrentProject()" title="Delete Project">
                        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        Delete
                    </button>
                    <button class="btn btn-primary" onclick="openTaskModal()" title="Add Task (N T)">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Add Task
                    </button>
                </div>
            </header>

            <div class="board-container" id="board" style="display:none;">
                <div class="column" data-status="todo">
                    <div class="column-header">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="column-status-bar"></div>
                            <span>To Do</span>
                        </div>
                        <span class="count" id="count-todo">0</span>
                    </div>
                    <div class="column-body" data-status="todo"></div>
                </div>
                <div class="column" data-status="inprogress">
                    <div class="column-header">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="column-status-bar"></div>
                            <span>In Progress</span>
                        </div>
                        <span class="count" id="count-inprogress">0</span>
                    </div>
                    <div class="column-body" data-status="inprogress"></div>
                </div>
                <div class="column" data-status="done">
                    <div class="column-header">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="column-status-bar"></div>
                            <span>Done</span>
                        </div>
                        <span class="count" id="count-done">0</span>
                    </div>
                    <div class="column-body" data-status="done"></div>
                </div>
            </div>

            <div id="noProjectState" style="display:none;flex:1;align-items:center;justify-content:center;">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7V7h2v10zm4 0h-2V7h2v10zm4 0h-2V7h2v10z"/></svg>
                    </div>
                    <h3>No project selected</h3>
                    <p>Select a project from the sidebar or create a new one to get started.</p>
                    <button class="btn btn-primary" onclick="openProjectModal()" style="margin-top:20px;">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Create a project
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModalOverlay">
        <div class="modal">
            <h2 id="taskModalTitle">Add New Task</h2>
            <form id="taskForm" autocomplete="off">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" id="taskTitle" required placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label>Description <span style="text-transform:none;font-weight:400;color:#9ca3af;">(optional)</span></label>
                    <textarea id="taskDesc" placeholder="Add more details about this task..."></textarea>
                </div>
                <div style="display:flex;gap:14px;">
                    <div class="form-group" style="flex:1;">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="low">üü¢ Low</option>
                            <option value="med">üü° Medium</option>
                            <option value="high">üî¥ High</option>
                        </select>
                    </div>
                    <div class="form-group" id="statusGroup" style="flex:1;">
                        <label>Status</label>
                        <select id="taskStatus">
                            <option value="todo">To Do</option>
                            <option value="inprogress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeTaskModal()">Cancel <kbd style="margin-left:4px;">Esc</kbd></button>
                    <button type="submit" class="btn btn-primary">Save Task <kbd style="margin-left:4px;background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.3);color:white;">‚Üµ</kbd></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal-overlay" id="projectModalOverlay">
        <div class="modal">
            <h2>Create New Project</h2>
            <form id="projectForm" autocomplete="off">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" required placeholder="e.g. Website Redesign">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import / Export Modal -->
    <div class="modal-overlay" id="importExportModalOverlay">
        <div class="modal modal-wide">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">Import / Export</h2>
                <button class="icon-btn" onclick="closeImportExportModal()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>

            <div class="import-export-tabs">
                <button class="import-export-tab active" id="tabExport" onclick="switchIETab('export')">Export</button>
                <button class="import-export-tab" id="tabImport" onclick="switchIETab('import')">Import</button>
            </div>

            <!-- Export panel -->
            <div id="exportPanel">
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;">Choose what to export as JSON:</p>
                <div class="export-scope form-group">
                    <label>
                        <input type="radio" name="exportScope" value="all" checked>
                        <div>
                            <strong>Everything</strong>
                            <div style="font-size:12px;color:var(--text-muted);">All projects and all tasks</div>
                        </div>
                    </label>
                    <label id="exportCurrentProjectLabel">
                        <input type="radio" name="exportScope" value="project">
                        <div>
                            <strong>Current project</strong>
                            <div id="exportCurrentProjectName" style="font-size:12px;color:var(--text-muted);">‚Äî no project selected ‚Äî</div>
                        </div>
                    </label>
                </div>
                <div class="modal-actions" style="margin-top:16px;">
                    <button type="button" class="btn btn-outline" onclick="closeImportExportModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="doExport()">
                        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Download JSON
                    </button>
                </div>
            </div>

            <!-- Import panel -->
            <div id="importPanel" style="display:none;">
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;">Import data from a previously exported FlowBoard JSON file. Imported projects will be added alongside existing ones.</p>

                <div class="import-drop-zone" id="importDropZone" onclick="document.getElementById('importFileInput').click()">
                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                    <div style="font-size:14px;font-weight:500;margin-bottom:4px;">Drop JSON file here</div>
                    <div style="font-size:12px;">or click to browse</div>
                </div>
                <input type="file" id="importFileInput" accept=".json,application/json">

                <div id="importPreviewWrap" style="display:none;margin-top:14px;">
                    <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;">Preview</div>
                    <div class="import-preview" id="importPreview"></div>
                    <div id="importSummary" style="font-size:13px;color:var(--text-main);margin-top:10px;padding:10px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;"></div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeImportExportModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="doImportBtn" onclick="doImport()" disabled>
                        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                        Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortcuts Overlay -->
    <div id="shortcutsOverlay">
        <div class="shortcuts-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">Keyboard Shortcuts</h2>
                <button class="icon-btn" onclick="closeShortcutsOverlay()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="shortcut-group">
                <div class="shortcut-group-title">Global</div>
                <div class="shortcut-row"><span>New Task</span><div class="shortcut-keys"><kbd>N</kbd> then <kbd>T</kbd></div></div>
                <div class="shortcut-row"><span>New Project</span><div class="shortcut-keys"><kbd>N</kbd> then <kbd>P</kbd></div></div>
                <div class="shortcut-row"><span>Rename current project</span><div class="shortcut-keys"><kbd>F2</kbd></div></div>
                <div class="shortcut-row"><span>Toggle Sidebar</span><div class="shortcut-keys"><kbd>Ctrl</kbd><span>+</span><kbd>B</kbd></div></div>
                <div class="shortcut-row"><span>Show Shortcuts</span><div class="shortcut-keys"><kbd>?</kbd></div></div>
                <div class="shortcut-row"><span>Close Modal / Deselect</span><div class="shortcut-keys"><kbd>Esc</kbd></div></div>
            </div>
            <div class="shortcut-group">
                <div class="shortcut-group-title">Task Navigation</div>
                <div class="shortcut-row"><span>Select task above / below</span><div class="shortcut-keys"><kbd>‚Üë</kbd><kbd>‚Üì</kbd></div></div>
                <div class="shortcut-row"><span>Move to next / prev column</span><div class="shortcut-keys"><kbd>Shift</kbd><span>+</span><kbd>‚Üê</kbd><kbd>‚Üí</kbd></div></div>
                <div class="shortcut-row"><span>Move task up / down in column</span><div class="shortcut-keys"><kbd>Shift</kbd><span>+</span><kbd>‚Üë</kbd><kbd>‚Üì</kbd></div></div>
                <div class="shortcut-row"><span>Edit selected task</span><div class="shortcut-keys"><kbd>E</kbd></div></div>
                <div class="shortcut-row"><span>Delete selected task</span><div class="shortcut-keys"><kbd>Del</kbd> / <kbd>‚å´</kbd></div></div>
            </div>
            <div class="shortcut-group">
                <div class="shortcut-group-title">Projects</div>
                <div class="shortcut-row"><span>Next / prev project</span><div class="shortcut-keys"><kbd>]</kbd> / <kbd>[</kbd></div></div>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const COLUMNS = ['todo', 'inprogress', 'done'];
        let appData = { projects: [], tasks: [], activeProjectId: null };
        let selectedTaskId = null;
        let keySequence = '';
        let keyTimer = null;

        // ‚îÄ‚îÄ‚îÄ Import/Export state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let importedData = null;
        let activeIETab = 'export';

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function init() {
            const stored = localStorage.getItem('myKanbanData_v1');
            if (stored) {
                try { appData = JSON.parse(stored); } catch(e) { createDemoData(); }
            } else {
                createDemoData();
            }
            const isCollapsed = localStorage.getItem('myKanbanSidebar') === 'true';
            if (isCollapsed) document.getElementById('sidebar').classList.add('collapsed');
            renderSidebar();
            renderBoard();
            setupKeyboard();
            setupImportDrop();
        }

        function createDemoData() {
            const id = generateId();
            appData.projects.push({ id, name: 'My Project' });
            appData.tasks.push(
                { id: generateId(), projectId: id, title: 'Explore the board', desc: 'Try dragging cards into other columns, or use Shift+Arrow keys.', priority: 'med', status: 'todo' },
                { id: generateId(), projectId: id, title: 'Add a new task', desc: 'Press N then T, or click Add Task in the top right.', priority: 'low', status: 'todo' },
                { id: generateId(), projectId: id, title: 'Learn shortcuts', desc: 'Press ? to see all available keyboard shortcuts.', priority: 'high', status: 'inprogress' },
                { id: generateId(), projectId: id, title: 'Create a project', desc: 'Use the + icon in the sidebar to create a new workspace.', priority: 'low', status: 'done' }
            );
            appData.activeProjectId = id;
            saveData();
        }

        function saveData() { localStorage.setItem('myKanbanData_v1', JSON.stringify(appData)); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        // ‚îÄ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setupKeyboard() { document.addEventListener('keydown', handleKeyDown); }
        function isModalOpen() {
            return document.querySelector('.modal-overlay.active') !== null ||
                   document.getElementById('shortcutsOverlay').classList.contains('active');
        }
        function isInputFocused() {
            const el = document.activeElement;
            return el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT');
        }

        function handleKeyDown(e) {
            if (e.key === 'Escape') {
                if (document.querySelector('.modal-overlay.active')) {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                    return;
                }
                if (document.getElementById('shortcutsOverlay').classList.contains('active')) { closeShortcutsOverlay(); return; }
                if (selectedTaskId) { clearSelection(); return; }
                // cancel inline project name edit
                const input = document.getElementById('projectTitleInput');
                if (input.style.display !== 'none') { cancelEditingProjectName(); return; }
            }

            // Commit project name editing with Enter
            if (e.key === 'Enter') {
                const input = document.getElementById('projectTitleInput');
                if (input.style.display !== 'none') { e.preventDefault(); commitProjectName(); return; }
            }

            if (isModalOpen() || isInputFocused()) return;

            if (e.key === 'F2') { e.preventDefault(); if (appData.activeProjectId) startEditingProjectName(); return; }
            if (e.key === '?' || e.key === '/') { e.preventDefault(); openShortcutsOverlay(); return; }
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); toggleSidebar(); return; }
            if (e.key === '[') { e.preventDefault(); cycleProject(-1); return; }
            if (e.key === ']') { e.preventDefault(); cycleProject(1); return; }

            if (!e.shiftKey && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) { e.preventDefault(); navigateTasks(e.key === 'ArrowDown' ? 1 : -1); return; }
            if (e.shiftKey && selectedTaskId) {
                if (e.key === 'ArrowRight') { e.preventDefault(); moveTaskColumn(1); return; }
                if (e.key === 'ArrowLeft') { e.preventDefault(); moveTaskColumn(-1); return; }
                if (e.key === 'ArrowDown') { e.preventDefault(); moveTaskInColumn(1); return; }
                if (e.key === 'ArrowUp') { e.preventDefault(); moveTaskInColumn(-1); return; }
            }
            if (e.key === 'e' && selectedTaskId) { e.preventDefault(); openTaskModal(selectedTaskId); return; }
            if ((e.key === 'Delete' || e.key === 'Backspace') && selectedTaskId) { e.preventDefault(); deleteTask(selectedTaskId); return; }

            if (e.key === 'n' || e.key === 'N') {
                keySequence = 'n';
                clearTimeout(keyTimer);
                keyTimer = setTimeout(() => { keySequence = ''; }, 1000);
                return;
            }
            if (keySequence === 'n') {
                if (e.key === 't' || e.key === 'T') { e.preventDefault(); keySequence = ''; if (appData.activeProjectId) openTaskModal(); return; }
                if (e.key === 'p' || e.key === 'P') { e.preventDefault(); keySequence = ''; openProjectModal(); return; }
                keySequence = '';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function clearSelection() {
            if (selectedTaskId) {
                const el = document.querySelector(`.task-card[data-id="${selectedTaskId}"]`);
                if (el) el.classList.remove('keyboard-selected');
                selectedTaskId = null;
            }
        }

        function selectTask(taskId) {
            clearSelection();
            selectedTaskId = taskId;
            const el = document.querySelector(`.task-card[data-id="${taskId}"]`);
            if (el) { el.classList.add('keyboard-selected'); el.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); }
        }

        function navigateTasks(dir) {
            const allCards = Array.from(document.querySelectorAll('.task-card'));
            if (!allCards.length) return;
            if (!selectedTaskId) { selectTask(allCards[dir === 1 ? 0 : allCards.length - 1].dataset.id); return; }
            const currentIdx = allCards.findIndex(c => c.dataset.id === selectedTaskId);
            if (currentIdx === -1) { selectTask(allCards[0].dataset.id); return; }
            selectTask(allCards[Math.max(0, Math.min(allCards.length - 1, currentIdx + dir))].dataset.id);
        }

        function moveTaskColumn(dir) {
            const task = appData.tasks.find(t => t.id === selectedTaskId);
            if (!task) return;
            const newColIdx = COLUMNS.indexOf(task.status) + dir;
            if (newColIdx < 0 || newColIdx >= COLUMNS.length) return;
            task.status = COLUMNS[newColIdx];
            saveData(); renderBoard(); selectTask(selectedTaskId);
            const labels = { todo: 'To Do', inprogress: 'In Progress', done: 'Done' };
            showToast(`Moved to ${labels[task.status]}`, 'info');
        }

        function moveTaskInColumn(dir) {
            updateDataFromDOM();
            const task = appData.tasks.find(t => t.id === selectedTaskId);
            if (!task) return;
            const colBody = document.querySelector(`.column-body[data-status="${task.status}"]`);
            const domOrder = Array.from(colBody.querySelectorAll('.task-card')).map(c => c.dataset.id);
            const currentPos = domOrder.indexOf(selectedTaskId);
            const newPos = currentPos + dir;
            if (newPos < 0 || newPos >= domOrder.length) return;
            domOrder.splice(currentPos, 1); domOrder.splice(newPos, 0, selectedTaskId);
            const colTasks = domOrder.map(id => appData.tasks.find(t => t.id === id)).filter(Boolean);
            const otherTasks = appData.tasks.filter(t => t.projectId !== appData.activeProjectId || t.status !== task.status);
            appData.tasks = [...otherTasks, ...colTasks];
            saveData(); renderBoard(); selectTask(selectedTaskId);
            const el = document.querySelector(`.task-card[data-id="${selectedTaskId}"]`);
            if (el) { el.classList.add('moving'); setTimeout(() => el.classList.remove('moving'), 250); }
        }

        function cycleProject(dir) {
            if (!appData.projects.length) return;
            const idx = appData.projects.findIndex(p => p.id === appData.activeProjectId);
            const newIdx = (idx + dir + appData.projects.length) % appData.projects.length;
            switchProject(appData.projects[newIdx].id);
        }

        // ‚îÄ‚îÄ‚îÄ Toasts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="toast-dot ${type}"></div>${msg}`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 200); }, 2200);
        }

        // ‚îÄ‚îÄ‚îÄ Sidebar / Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('myKanbanSidebar', sidebar.classList.contains('collapsed'));
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, t => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' })[t]);
        }

        // ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderSidebar() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            appData.projects.forEach(proj => {
                const div = document.createElement('div');
                div.className = `project-item ${proj.id === appData.activeProjectId ? 'active' : ''}`;
                div.title = proj.name;
                div.innerHTML = `
                    <div class="project-icon-wrap">
                        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    </div>
                    <span class="hide-on-collapse" style="overflow:hidden;text-overflow:ellipsis;flex:1;">${escapeHTML(proj.name)}</span>
                    <button class="project-edit-btn hide-on-collapse" title="Rename" onclick="event.stopPropagation();quickRenameProject('${proj.id}')">
                        <svg viewBox="0 0 24 24" style="width:11px;height:11px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    </button>
                `;
                div.addEventListener('click', () => switchProject(proj.id));
                list.appendChild(div);
            });
        }

        function renderBoard() {
            const activeProject = appData.projects.find(p => p.id === appData.activeProjectId);
            const headerActions = document.getElementById('headerActions');
            const board = document.getElementById('board');
            const noProjectState = document.getElementById('noProjectState');
            const titleEl = document.getElementById('currentProjectTitle');
            const editBtn = document.getElementById('editProjectNameBtn');

            if (!activeProject) {
                titleEl.textContent = 'Welcome to FlowBoard';
                editBtn.style.display = 'none';
                headerActions.style.display = 'none';
                board.style.display = 'none';
                noProjectState.style.display = 'flex';
                return;
            }

            titleEl.textContent = activeProject.name;
            editBtn.style.display = '';
            headerActions.style.display = 'flex';
            board.style.display = 'flex';
            noProjectState.style.display = 'none';

            document.querySelectorAll('.column-body').forEach(col => col.innerHTML = '');
            const counts = { todo: 0, inprogress: 0, done: 0 };
            appData.tasks.filter(t => t.projectId === appData.activeProjectId).forEach(task => {
                const col = document.querySelector(`.column-body[data-status="${task.status}"]`);
                if (col) { col.appendChild(createTaskElement(task)); if (counts[task.status] !== undefined) counts[task.status]++; }
            });

            document.querySelectorAll('.column-body').forEach(col => {
                const btn = document.createElement('button');
                btn.className = 'add-task-inline';
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Add task`;
                btn.onclick = () => openTaskModal(null, col.dataset.status);
                col.appendChild(btn);
            });

            document.getElementById('count-todo').textContent = counts.todo;
            document.getElementById('count-inprogress').textContent = counts.inprogress;
            document.getElementById('count-done').textContent = counts.done;

            if (selectedTaskId) {
                const el = document.querySelector(`.task-card[data-id="${selectedTaskId}"]`);
                if (el) el.classList.add('keyboard-selected');
                else selectedTaskId = null;
            }
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            el.className = 'task-card';
            el.dataset.id = task.id;
            const priorityLabel = { high: 'High', med: 'Med', low: 'Low' }[task.priority] || 'Low';
            el.innerHTML = `
                <div class="task-badges"><span class="badge badge-${task.priority}">${priorityLabel}</span></div>
                <div class="task-title">${escapeHTML(task.title)}</div>
                ${task.desc ? `<div class="task-desc">${escapeHTML(task.desc)}</div>` : ''}
                <div class="task-footer">
                    <div style="flex:1;"></div>
                    <div class="task-actions">
                        <button class="icon-btn" title="Edit (E)" onclick="openTaskModal('${task.id}')">
                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                        <button class="icon-btn" title="Delete (Del)" onclick="deleteTask('${task.id}')" style="color:var(--danger)">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
            `;
            el.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                if (selectedTaskId === task.id) clearSelection();
                else selectTask(task.id);
            });
            el.addEventListener('pointerdown', (e) => { if (e.target.closest('button') || e.button !== 0) return; initDrag(e, el, task); });
            return el;
        }

        // ‚îÄ‚îÄ‚îÄ Inline Project Name Editing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function startEditingProjectName() {
            const project = appData.projects.find(p => p.id === appData.activeProjectId);
            if (!project) return;
            const titleEl = document.getElementById('currentProjectTitle');
            const input = document.getElementById('projectTitleInput');
            const editBtn = document.getElementById('editProjectNameBtn');
            titleEl.style.display = 'none';
            editBtn.style.display = 'none';
            input.value = project.name;
            input.style.display = '';
            input.focus();
            input.select();
        }

        function commitProjectName() {
            const input = document.getElementById('projectTitleInput');
            const newName = input.value.trim();
            const project = appData.projects.find(p => p.id === appData.activeProjectId);
            if (project && newName) {
                project.name = newName;
                saveData();
                renderSidebar();
                showToast('Project renamed');
            }
            cancelEditingProjectName();
        }

        function cancelEditingProjectName() {
            const titleEl = document.getElementById('currentProjectTitle');
            const input = document.getElementById('projectTitleInput');
            const editBtn = document.getElementById('editProjectNameBtn');
            const project = appData.projects.find(p => p.id === appData.activeProjectId);
            if (project) titleEl.textContent = project.name;
            titleEl.style.display = '';
            editBtn.style.display = '';
            input.style.display = 'none';
        }

        document.getElementById('projectTitleInput').addEventListener('blur', () => {
            const input = document.getElementById('projectTitleInput');
            if (input.style.display !== 'none') commitProjectName();
        });

        // sidebar rename via pencil icon
        function quickRenameProject(projectId) {
            const project = appData.projects.find(p => p.id === projectId);
            if (!project) return;
            const newName = prompt('Rename project:', project.name);
            if (newName && newName.trim()) {
                project.name = newName.trim();
                saveData();
                renderSidebar();
                renderBoard();
                showToast('Project renamed');
            }
        }

        // ‚îÄ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let dragState = null;

        function initDrag(e, cardEl, task) {
            const startX = e.clientX, startY = e.clientY;
            let started = false;

            function onMove(ev) {
                if (!started) {
                    if (Math.hypot(ev.clientX - startX, ev.clientY - startY) < 6) return;
                    started = true;
                    beginDrag(ev, cardEl, task, startX, startY);
                } else { moveDrag(ev); }
            }
            function onUp(ev) {
                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', onUp);
                if (started) endDrag(ev);
            }
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp);
        }

        function beginDrag(e, cardEl, task, startX, startY) {
            const rect = cardEl.getBoundingClientRect();
            const ghost = document.createElement('div');
            ghost.id = 'dragGhost';
            ghost.innerHTML = cardEl.innerHTML;
            ghost.querySelector('.task-actions').style.opacity = '0';
            ghost.style.left = rect.left + 'px';
            ghost.style.top = rect.top + 'px';
            ghost.style.width = rect.width + 'px';
            ghost.style.transform = 'rotate(0deg) scale(1)';
            document.body.appendChild(ghost);
            requestAnimationFrame(() => {
                ghost.style.transition = 'transform 0.15s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.15s';
                ghost.style.transform = 'rotate(2deg) scale(1.03)';
                ghost.style.boxShadow = '0 32px 64px rgba(0,0,0,0.25), 0 8px 24px rgba(37,99,235,0.2)';
            });
            const placeholder = document.createElement('div');
            placeholder.className = 'drop-placeholder';
            placeholder.style.height = rect.height + 'px';
            cardEl.parentNode.insertBefore(placeholder, cardEl);
            cardEl.classList.add('drag-source');
            document.body.classList.add('is-dragging');
            dragState = { cardEl, task, ghost, placeholder, offsetX: startX - rect.left, offsetY: startY - rect.top, lastTarget: null };
        }

        function moveDrag(e) {
            if (!dragState) return;
            const { ghost, offsetX, offsetY, placeholder } = dragState;
            ghost.style.left = (e.clientX - offsetX) + 'px';
            ghost.style.top = (e.clientY - offsetY) + 'px';
            const col = getColumnAtPoint(e.clientX, e.clientY);
            if (col) {
                if (dragState.lastTarget && dragState.lastTarget !== col) {
                    dragState.lastTarget.classList.remove('drag-over');
                    dragState.lastTarget.closest('.column')?.classList.remove('drag-target');
                }
                col.classList.add('drag-over');
                col.closest('.column')?.classList.add('drag-target');
                dragState.lastTarget = col;
                const after = getDragAfterElement(col, e.clientY, placeholder);
                if (after) col.insertBefore(placeholder, after);
                else col.insertBefore(placeholder, col.querySelector('.add-task-inline') || null);
            }
        }

        function endDrag(e) {
            if (!dragState) return;
            const { cardEl, ghost, placeholder, lastTarget } = dragState;
            const phRect = placeholder.getBoundingClientRect();
            ghost.style.transition = 'left 0.28s cubic-bezier(0.34,1.56,0.64,1), top 0.28s cubic-bezier(0.34,1.56,0.64,1), transform 0.28s, opacity 0.2s ease 0.1s';
            ghost.style.left = phRect.left + 'px';
            ghost.style.top = phRect.top + 'px';
            ghost.style.transform = 'rotate(0deg) scale(1)';
            ghost.style.opacity = '0';
            placeholder.parentNode.insertBefore(cardEl, placeholder);
            placeholder.remove();
            cardEl.classList.remove('drag-source');
            setTimeout(() => { ghost.remove(); updateDataFromDOM(); }, 320);
            if (lastTarget) { lastTarget.classList.remove('drag-over'); lastTarget.closest('.column')?.classList.remove('drag-target'); }
            dragState = null;
            document.body.classList.remove('is-dragging');
        }

        function getColumnAtPoint(x, y) {
            for (const col of document.querySelectorAll('.column-body')) {
                const colWrap = col.closest('.column').getBoundingClientRect();
                const rect = col.getBoundingClientRect();
                if (x >= colWrap.left && x <= colWrap.right && y >= rect.top - 40 && y <= rect.bottom + 20) return col;
            }
            return null;
        }

        function getDragAfterElement(container, y, excludeEl) {
            return Array.from(container.querySelectorAll('.task-card:not(.drag-source)')).reduce((closest, child) => {
                if (child === excludeEl) return closest;
                const offset = y - child.getBoundingClientRect().top - child.getBoundingClientRect().height / 2;
                return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // ‚îÄ‚îÄ‚îÄ Data Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDataFromDOM() {
            const others = appData.tasks.filter(t => t.projectId !== appData.activeProjectId);
            const reordered = [];
            document.querySelectorAll('.column-body').forEach(col => {
                col.querySelectorAll('.task-card').forEach(card => {
                    const task = appData.tasks.find(t => t.id === card.dataset.id);
                    if (task) { task.status = col.dataset.status; reordered.push(task); }
                });
            });
            appData.tasks = others.concat(reordered);
            saveData(); renderBoard();
        }

        function switchProject(projectId) {
            clearSelection(); appData.activeProjectId = projectId; saveData(); renderSidebar(); renderBoard();
        }

        function deleteCurrentProject() {
            const project = appData.projects.find(p => p.id === appData.activeProjectId);
            if (!project) return;
            if (!confirm(`Delete "${project.name}" and all its tasks?`)) return;
            appData.tasks = appData.tasks.filter(t => t.projectId !== appData.activeProjectId);
            appData.projects = appData.projects.filter(p => p.id !== appData.activeProjectId);
            appData.activeProjectId = appData.projects.length > 0 ? appData.projects[0].id : null;
            saveData(); renderSidebar(); renderBoard();
            showToast('Project deleted', 'info');
        }

        function deleteTask(taskId) {
            if (!confirm('Permanently delete this task?')) return;
            if (selectedTaskId === taskId) clearSelection();
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            saveData(); renderBoard();
            showToast('Task deleted', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openProjectModal() {
            document.getElementById('projectForm').reset();
            document.getElementById('projectModalOverlay').classList.add('active');
            setTimeout(() => document.getElementById('projectName').focus(), 150);
        }
        function closeProjectModal() { document.getElementById('projectModalOverlay').classList.remove('active'); }

        document.getElementById('projectForm').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('projectName').value.trim();
            if (!name) return;
            const newProject = { id: generateId(), name };
            appData.projects.push(newProject);
            appData.activeProjectId = newProject.id;
            saveData(); closeProjectModal(); renderSidebar(); renderBoard();
            showToast(`Project "${name}" created`);
        });

        function openTaskModal(taskId = null, defaultStatus = 'todo') {
            document.getElementById('taskForm').reset();
            const statusGroup = document.getElementById('statusGroup');
            if (taskId) {
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                statusGroup.style.display = 'block';
                const task = appData.tasks.find(t => t.id === taskId);
                if (!task) return;
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDesc').value = task.desc || '';
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status;
            } else {
                document.getElementById('taskModalTitle').textContent = 'Add New Task';
                statusGroup.style.display = defaultStatus !== 'todo' ? 'block' : 'none';
                document.getElementById('taskId').value = '';
                document.getElementById('taskStatus').value = defaultStatus;
            }
            document.getElementById('taskModalOverlay').classList.add('active');
            setTimeout(() => document.getElementById('taskTitle').focus(), 150);
        }
        function closeTaskModal() { document.getElementById('taskModalOverlay').classList.remove('active'); }

        document.getElementById('taskForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value.trim();
            const desc = document.getElementById('taskDesc').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const status = document.getElementById('taskStatus').value;
            if (id) {
                const task = appData.tasks.find(t => t.id === id);
                if (task) { task.title = title; task.desc = desc; task.priority = priority; task.status = status; }
                showToast('Task updated');
            } else {
                appData.tasks.push({ id: generateId(), projectId: appData.activeProjectId, title, desc, priority, status });
                showToast('Task added');
            }
            saveData(); closeTaskModal(); renderBoard();
        });

        // ‚îÄ‚îÄ‚îÄ Import / Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openImportExportModal() {
            switchIETab('export');
            importedData = null;
            document.getElementById('importPreviewWrap').style.display = 'none';
            document.getElementById('doImportBtn').disabled = true;
            document.getElementById('importFileInput').value = '';

            // Update export label with current project name
            const project = appData.projects.find(p => p.id === appData.activeProjectId);
            document.getElementById('exportCurrentProjectName').textContent = project ? project.name : '‚Äî no project selected ‚Äî';
            document.querySelector('input[name=exportScope][value="project"]').disabled = !project;

            document.getElementById('importExportModalOverlay').classList.add('active');
        }
        function closeImportExportModal() { document.getElementById('importExportModalOverlay').classList.remove('active'); }

        function switchIETab(tab) {
            activeIETab = tab;
            document.getElementById('tabExport').classList.toggle('active', tab === 'export');
            document.getElementById('tabImport').classList.toggle('active', tab === 'import');
            document.getElementById('exportPanel').style.display = tab === 'export' ? '' : 'none';
            document.getElementById('importPanel').style.display = tab === 'import' ? '' : 'none';
        }

        function doExport() {
            const scope = document.querySelector('input[name=exportScope]:checked').value;
            let exportObj;
            if (scope === 'all') {
                exportObj = { version: 1, exported: new Date().toISOString(), projects: appData.projects, tasks: appData.tasks };
            } else {
                const project = appData.projects.find(p => p.id === appData.activeProjectId);
                const tasks = appData.tasks.filter(t => t.projectId === appData.activeProjectId);
                exportObj = { version: 1, exported: new Date().toISOString(), projects: [project], tasks };
            }
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flowboard-export-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            closeImportExportModal();
            showToast('Exported successfully');
        }

        function setupImportDrop() {
            const zone = document.getElementById('importDropZone');
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-active'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-active'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-active');
                const file = e.dataTransfer.files[0];
                if (file) processImportFile(file);
            });
            document.getElementById('importFileInput').addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) processImportFile(file);
            });
        }

        function processImportFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.projects || !data.tasks || !Array.isArray(data.projects) || !Array.isArray(data.tasks)) {
                        showToast('Invalid FlowBoard JSON file', 'warn');
                        return;
                    }
                    importedData = data;
                    const preview = JSON.stringify(data, null, 2).slice(0, 800) + (JSON.stringify(data).length > 800 ? '\n...' : '');
                    document.getElementById('importPreview').textContent = preview;
                    document.getElementById('importSummary').innerHTML =
                        `<strong>Ready to import:</strong> ${data.projects.length} project${data.projects.length !== 1 ? 's' : ''}, ${data.tasks.length} task${data.tasks.length !== 1 ? 's' : ''}. These will be <strong>added</strong> alongside your existing data.`;
                    document.getElementById('importPreviewWrap').style.display = '';
                    document.getElementById('doImportBtn').disabled = false;
                } catch (err) {
                    showToast('Could not parse JSON file', 'warn');
                }
            };
            reader.readAsText(file);
        }

        function doImport() {
            if (!importedData) return;

            // Remap IDs to avoid collisions
            const idMap = {};
            const newProjects = importedData.projects.map(p => {
                const newId = generateId();
                idMap[p.id] = newId;
                return { ...p, id: newId };
            });
            const newTasks = importedData.tasks.map(t => ({
                ...t,
                id: generateId(),
                projectId: idMap[t.projectId] || t.projectId
            }));

            appData.projects = appData.projects.concat(newProjects);
            appData.tasks = appData.tasks.concat(newTasks);

            if (newProjects.length > 0 && !appData.activeProjectId) {
                appData.activeProjectId = newProjects[0].id;
            }

            saveData(); renderSidebar(); renderBoard();
            closeImportExportModal();
            showToast(`Imported ${newProjects.length} project${newProjects.length !== 1 ? 's' : ''} and ${newTasks.length} task${newTasks.length !== 1 ? 's' : ''}`);
        }

        function openShortcutsOverlay() { document.getElementById('shortcutsOverlay').classList.add('active'); }
        function closeShortcutsOverlay() { document.getElementById('shortcutsOverlay').classList.remove('active'); }

        window.addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) {
                closeProjectModal(); closeTaskModal(); closeImportExportModal();
            }
            if (e.target === document.getElementById('shortcutsOverlay')) closeShortcutsOverlay();
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>